<!DOCTYPE html>

<html lang="zh-CN">

<head>
  
  <title>第 三 周 write up [TokyoWesterns-Web-shrine(ssti) 2017-赛客夏令营-Web-random(随机) 2017-赛客夏令营-Web-weakphp(git,md5)] - tothemoon &#39; s blog</title>
  <meta charset="UTF-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  
  

  <link rel="shortcut icon" href="https://gitee.com/tothemoon_2020/picgo/raw/master/img/20201005095528.jpeg" type="image/png" />
  <meta name="description" content="BJDCTF-2020-Web-Cookie is so subtle!先百度  瞎测了一下，居然测出给git泄露了？  跑了下脚本，不是git泄露。    淦  重新开始 在hint下面发现了提示  在flag.php页面登陆后，抓包发现，cookie里面多了变量user。  看了大佬的提示：是模板注入，靠，这怎么想得到啊。菜鸡我是真的涨姿势了。 如果输入NaN如果  输出7777777 则是j">
<meta property="og:type" content="article">
<meta property="og:title" content="第 三 周 write up [TokyoWesterns-Web-shrine(ssti) 2017-赛客夏令营-Web-random(随机) 2017-赛客夏令营-Web-weakphp(git,md5)]">
<meta property="og:url" content="http://tothemoon2019.github.io/2020/10/15/%E7%AC%AC%20%E5%9B%9B%20%E5%91%A8%20writeup[%20BJDCTF-2020-Web-Cookie%20is%20so%20subtle!(twig,ssti)%20Bugku%20%E8%B9%AD%E7%BD%91%E5%85%88%E8%A7%A3%E5%BC%80%E5%AF%86%E7%A0%81(hashcat)%20[%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E9%9D%92%E9%BE%99%E7%BB%84]AreUSerialz(%E5%BA%8F%E5%88%97%E5%8C%96,protected)]/index.html">
<meta property="og:site_name" content="tothemoon &#39; s blog">
<meta property="og:description" content="BJDCTF-2020-Web-Cookie is so subtle!先百度  瞎测了一下，居然测出给git泄露了？  跑了下脚本，不是git泄露。    淦  重新开始 在hint下面发现了提示  在flag.php页面登陆后，抓包发现，cookie里面多了变量user。  看了大佬的提示：是模板注入，靠，这怎么想得到啊。菜鸡我是真的涨姿势了。 如果输入NaN如果  输出7777777 则是j">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201010200127760.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012194341050.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012194822379.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012200132199.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201014123841249.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/clip_image002.jpg">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013213830021.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/clip_image004.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/clip_image008.jpg">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/clip_image006.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012121753825.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012122440823.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012122529106.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012185323925.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012185651596.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012185354618.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012192803014.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012192924479.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012192956249.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012193026204.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012193201785.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012185459965.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013204701298.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013205945042.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013211156123.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013211206892.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013211235721.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013211244198.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201014211510289.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201014211510289.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015165739104.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015171118170.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015171300459.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015172331260.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015172542221.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015172651092.png">
<meta property="og:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013213251591.png">
<meta property="article:published_time" content="2020-10-15T12:36:16.000Z">
<meta property="article:modified_time" content="2020-10-15T12:43:46.492Z">
<meta property="article:author" content="tothemoon">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201010200127760.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/gh/nexmoe/nexmoe.github.io@latest/css/style.css,npm/highlight.js@9.15.8/styles/atom-one-dark.css,gh/nexmoe/nexmoe.github.io@latest/lib/mdui_043tiny/css/mdui.css,gh/nexmoe/nexmoe.github.io@latest/lib/iconfont/iconfont.css" crossorigin>
  
  <!--<link rel="stylesheet" href="/css/style.css?v=1602765863212">-->

   
    <style>
      .nexmoe-avatar img:hover {
        -webkit-transform: rotateZ(360deg);
        -moz-transform: rotateZ(360deg);
        transform: rotateZ(360deg);
      }	
    </style>
  
<meta name="generator" content="Hexo 5.2.0"></head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(https://gitee.com/tothemoon_2020/picgo/raw/master/img/20201005170714.jpg)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="tothemoon" class="mdui-btn mdui-btn-icon"><img src="https://gitee.com/tothemoon_2020/picgo/raw/master/darksoul.png" alt="tothemoon"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="tothemoon">
            <img src="https://gitee.com/tothemoon_2020/picgo/raw/master/darksoul.png" alt="tothemoon" alt="tothemoon">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>4</div>
        <div><span>标签</span>0</div>
        <div><span>分类</span>2</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/archives" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
        <form id="search_form" action_e="https://www.baidu.com/search?q=site:tothemoon2019.github.io" onsubmit="return search();">
            <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
        </form>
    </div>
</div>
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">社交按钮</h3>
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://space.bilibili.com/28841207" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/tothemoon2019" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(0，0，0);background-color: rgba(25,23,23,.1);">
            <i class="nexmoefont icon-github"></i>
        </a><a class="mdui-ripple" href="https://steamcommunity.com/profiles/76561198234182404/" target="_blank" mdui-tooltip="{content: 'steam'}" style="color: rgb(25, 23, 23);background-color: rgba(14,71,161,.1);">
            <i class="nexmoefont icon-steam"></i>
        </a><a class="mdui-ripple" href="https://www.zhihu.com/people/beezhu-zou" target="_blank" mdui-tooltip="{content: '知乎'}" style="color: color:#1e88e5;background-color: rgba(0, 0, 255, .15);">
            <i class="nexmoefont icon-zhihu"></i>
        </a><a class="mdui-ripple" href="https://blog.csdn.net/qq_43478096" target="_blank" mdui-tooltip="{content: 'csdn'}" style="color: color:#1e88e5;background-color: rgba(0, 0, 255, .15);">
            <i class="nexmoefont https://csdnimg.cn/public/favicon.ico"></i>
        </a>
    </div>
</div>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/ctf/">ctf</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/杂项/">杂项</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li></ul>
    </div>
  </div>


  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2020 tothemoon
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://nexmoe.com/hexo-theme-nexmoe.html" target="_blank">Nexmoe</a>
    </div>
</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
  
      <div class="nexmoe-post-cover" style="padding-bottom: 20%;"> 
          <img data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/20201015204328.png" data-sizes="auto" alt="第 三 周 write up [TokyoWesterns-Web-shrine(ssti) 2017-赛客夏令营-Web-random(随机) 2017-赛客夏令营-Web-weakphp(git,md5)]" class="lazyload">
          <h1>第 三 周 write up [TokyoWesterns-Web-shrine(ssti) 2017-赛客夏令营-Web-random(随机) 2017-赛客夏令营-Web-weakphp(git,md5)]</h1>
      </div>
  
  
  <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2020年10月15日</a>
    <a><i class="nexmoefont icon-areachart"></i>1.3k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 6 分钟</a>
</div>

  <div class="nexmoe-post-right">
    
      <div class="nexmoe-fixed">
        <div class="nexmoe-valign">
            <div class="nexmoe-toc">
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BJDCTF-2020-Web-Cookie-is-so-subtle"><span class="toc-number">1.</span> <span class="toc-text">BJDCTF-2020-Web-Cookie is so subtle!</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#success"><span class="toc-number">1.1.</span> <span class="toc-text">success</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bugku-%E8%B9%AD%E7%BD%91%E5%85%88%E8%A7%A3%E5%BC%80%E5%AF%86%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">Bugku 蹭网先解开密码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#hashcat"><span class="toc-number">2.1.</span> <span class="toc-text">hashcat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EWSA"><span class="toc-number">2.2.</span> <span class="toc-text">EWSA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#success-1"><span class="toc-number">2.3.</span> <span class="toc-text">success</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E9%9D%92%E9%BE%99%E7%BB%84-AreUSerialz"><span class="toc-number">3.</span> <span class="toc-text">[网鼎杯 2020 青龙组]AreUSerialz</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#success-2"><span class="toc-number">3.1.</span> <span class="toc-text">success</span></a></li></ol></li></ol>
            </div>
        </div>
      </div>
    
  </div>

  <article>
    <h1 id="BJDCTF-2020-Web-Cookie-is-so-subtle"><a href="#BJDCTF-2020-Web-Cookie-is-so-subtle" class="headerlink" title="BJDCTF-2020-Web-Cookie is so subtle!"></a>BJDCTF-2020-Web-Cookie is so subtle!</h1><p>先百度</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201010200127760.png" alt="image-20201010200127760" class="lazyload"></p>
<p>瞎测了一下，居然测出给git泄露了？</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012194341050.png" alt="image-20201012194341050" class="lazyload"></p>
<p>跑了下脚本，不是git泄露。    淦</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012194822379.png" alt="image-20201012194822379" class="lazyload"></p>
<p>重新开始</p>
<p>在hint下面发现了提示</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012200132199.png" alt="image-20201012200132199" class="lazyload"></p>
<p>在flag.php页面登陆后，抓包发现，cookie里面多了变量user。</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201014123841249.png" alt="image-20201014123841249" class="lazyload"></p>
<p>看了大佬的提示：是模板注入，靠，这怎么想得到啊。菜鸡我是真的涨姿势了。</p>
<p>如果输入NaN如果  <code>输出7777777 则是jinja2模板</code>                                <code>如果是 49 则是 twig模板</code></p>
<p>这里输出了49 则这是 <code>twig模板注入</code>了</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/clip_image002.jpg" alt="img" class="lazyload"></p>
<p>大佬的在博客中指出了怎样构造pauload</p>
<p><a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/#2-Twig">https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/#2-Twig</a></p>
<p>我这里简单总结一下</p>
<p>twig提供了一个_self，它可以调用env（env是指属性Twig_Environment对象，Twig_Environment对象有一个 setCache方法可用于更改Twig尝试加载和执行编译模板（PHP文件）的位置）</p>
<p>不过call_user_function()函数一般被php禁用了，不过有一个getFile() 可以调用call_user_function()</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013213830021.png" alt="image-20201013213830021" class="lazyload"></p>
<p>然后利用registerUnderfinedFilterCallback()函数将exec作为回调函数传进去。</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/clip_image004.png" alt="img" class="lazyload"></p>
<p>至此payload创建成功，只需要在后面加上自己想要执行的命令就行了</p>
<p>payload：</p>
<p><code>&#123;&#123;_self.env.registerUndefinedFilterCallback("exec")&#125;&#125;&#123;&#123;_self.env.getFilter("cat /flag")&#125;&#125;</code></p>
<p> <img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/clip_image008.jpg" alt="img" class="lazyload"></p>
<h2 id="success"><a href="#success" class="headerlink" title="success"></a>success</h2><p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/clip_image006.png" alt="img" class="lazyload"></p>
<p>  <a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/#2-Twig">https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/#2-Twig</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Aidang/article/details/108182487">https://blog.csdn.net/Aidang/article/details/108182487</a> </p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/28823933">https://zhuanlan.zhihu.com/p/28823933</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7518">https://xz.aliyun.com/t/7518</a></p>
<h1 id="Bugku-蹭网先解开密码"><a href="#Bugku-蹭网先解开密码" class="headerlink" title="Bugku 蹭网先解开密码"></a>Bugku 蹭网先解开密码</h1><p>无意中得知了hashcat这个神奇 ，但是第一次接触不会用啊，于是在网上找题目实战，刚好bugku就有一道用hashcat破解wifi密码的杂项题。</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012121753825.png" alt="image-20201012121753825" class="lazyload"></p>
<p>下载wifi.cap文件，这个文件是wifi的握手包，即为采用的wpa加密方式的无线ap与无线客户端连接前的认证信息包，可以通过这个握手包暴力破解密码。</p>
<p>因为是破解，所以得写一个电话号码的字典给它跑。电话号码一般都是11位的，而且这里还告诉了前8位，所以用脚本生成一个11位的电话号码字典。</p>
<pre><code class="python">a = 1391040
f = open(&#39;pass.txt&#39;, &#39;w&#39;)
for i in range(0,1000):
    psd = a + str(i).zfill(4)
    f.write(psd+&#39;\n&#39;)</code></pre>
<h2 id="hashcat"><a href="#hashcat" class="headerlink" title="hashcat"></a>hashcat</h2><p>然后到 <a target="_blank" rel="noopener" href="https://hashcat.net/hashcat/">https://hashcat.net/hashcat/</a> 下载 hashcat binaries 文件</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012122440823.png" alt="image-20201012122440823" class="lazyload"></p>
<p>到 <a target="_blank" rel="noopener" href="https://hashcat.net/cap2hccapx/">https://hashcat.net/cap2hccapx/</a> 将 .cap文件转换成 .hccapx文件</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012122529106.png" alt="image-20201012122529106" class="lazyload"></p>
<p>然后将hccapx文件与字典放入hashcat的文件夹</p>
<p>输入命令 <code>vhashcat.exe -m 2500 1.hccapx pass.txt</code></p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012185323925.png" alt="image-20201012185323925" class="lazyload"></p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012185651596.png" alt="image-20201012185651596" class="lazyload"></p>
<p>成功跑出手机号码</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012185354618.png" alt="image-20201012185354618" class="lazyload"></p>
<h2 id="EWSA"><a href="#EWSA" class="headerlink" title="EWSA"></a>EWSA</h2><p>导入握手包</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012192803014.png" alt="image-20201012192803014" class="lazyload"></p>
<p>点击ok</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012192924479.png" alt="image-20201012192924479" class="lazyload"></p>
<p>导入字典</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012192956249.png" alt="image-20201012192956249" class="lazyload"></p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012193026204.png" alt="image-20201012193026204" class="lazyload"></p>
<p>开始爆破</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012193201785.png" alt="image-20201012193201785" class="lazyload"></p>
<h2 id="success-1"><a href="#success-1" class="headerlink" title="success"></a>success</h2><p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201012185459965.png" alt="image-20201012185459965" class="lazyload"></p>
<h1 id="网鼎杯-2020-青龙组-AreUSerialz"><a href="#网鼎杯-2020-青龙组-AreUSerialz" class="headerlink" title="[网鼎杯 2020 青龙组]AreUSerialz"></a>[网鼎杯 2020 青龙组]AreUSerialz</h1><p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Cl0ud/p/12874458.html">https://www.cnblogs.com/Cl0ud/p/12874458.html</a></p>
<p>打开就是源码，加上名字已经暗示的很清楚了，这是一道反序列化的代码审计题</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013204701298.png" alt="image-20201013204701298" class="lazyload"></p>
<p>注入点是在最后，要给str传参，传的值得经过<code>is_valid()</code>函数进行判断</p>
<pre><code class="php">function is_valid($s) &#123;
    for($i = 0; $i &lt; strlen($s); $i++)
        if(!(ord($s[$i]) &gt;= 32 &amp;&amp; ord($s[$i]) &lt;= 125))
            return false;
    return true;
&#125;


if(isset($_GET&#123;&#39;str&#39;&#125;)) &#123;

    $str = (string)$_GET[&#39;str&#39;];
    if(is_valid($str)) &#123;
        $obj = unserialize($str);
    &#125;

&#125;</code></pre>
<p>ord()函数返回字符的ascll值，这里的判断条件是str字符串里的每个字符的都得ascll都得大于32，或小于125。</p>
<p>具体可以去查表，大概也就是说以下和一些不可取。</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013205945042.png" alt="image-20201013205945042" class="lazyload"></p>
<p>不管怎样，先把源码放进本地环境跑跑</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013211156123.png" alt="image-20201013211156123" class="lazyload"></p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013211206892.png" alt="image-20201013211206892" class="lazyload"></p>
<p>给str传参，回显bad hacker！这时就该去<code>FileHandler ()</code> 里面看看有没有可以利用的函数了。</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013211235721.png" alt="image-20201013211235721" class="lazyload"><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013211244198.png" alt="image-20201013211244198" class="lazyload"></p>
<p>太菜了，都忘记会先调用构造函数destruct()了。它会先进行<code>强类型比较</code>通过的话把1赋给op，然后将content赋为空，转到process去</p>
<pre><code class="php">function __destruct() &#123;
    if($this-&gt;op === &quot;2&quot;)
        $this-&gt;op = &quot;1&quot;;
    $this-&gt;content = &quot;&quot;;
    $this-&gt;process();
&#125;</code></pre>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201014211510289.png" alt="image-20201014211510289" class="lazyload"></p>
<p>如果op为1就执行write()，如果op为2就执行read()，read函数后面还有一个output函数输出。感觉这里应该可以利用来输出flag。</p>
<pre><code class="php">public function process() &#123;
    if($this-&gt;op == &quot;1&quot;) &#123;
        $this-&gt;write();
    &#125; else if($this-&gt;op == &quot;2&quot;) &#123;
        $res = $this-&gt;read();
        $this-&gt;output($res);
    &#125; else &#123;
        $this-&gt;output(&quot;Bad Hacker!&quot;);
    &#125;
&#125;</code></pre>
<p>read 里面有file_get_contents() 应该可以用来读取文件</p>
<pre><code class="php">private function read() &#123;
    $res = &quot;&quot;;
    if(isset($this-&gt;filename)) &#123;
        $res = file_get_contents($this-&gt;filename);
    &#125;
    return $res;
&#125;</code></pre>
<p>毕竟是读文件感觉write应该没用。</p>
<p>为了进行读flag，op必须为2，但这里可以用强类型绕过只要两边值的类型不同就直接false，所以给op赋值为整型的2，因为比较的时候op比较的是str类型的2，就直接false了。</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201014211510289.png" alt="image-20201014211510289" class="lazyload"><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015165739104.png" alt="image-20201015165739104" class="lazyload"></p>
<p>在构造函数里将op赋值整型2，filrname为flag.php</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015171118170.png" alt="image-20201015171118170" class="lazyload"></p>
<p>这时看到序列化后的字符串有方块，这事实上是ascll为0的空字符，用这个去当payload肯定是不行了。</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015171300459.png" alt="image-20201015171300459" class="lazyload"></p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015172331260.png" alt="image-20201015172331260" class="lazyload"></p>
<p>上网查了下，因为前面设置变量的时候设置的私有变量，私有变量序列化后就会有空字符。为了去掉这个，大佬说可以将</p>
<p>protected属性改为public</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015172542221.png" alt="image-20201015172542221" class="lazyload"></p>
<p>跑payload：</p>
<p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201015172651092.png" alt="image-20201015172651092" class="lazyload"></p>
<h2 id="success-2"><a href="#success-2" class="headerlink" title="success"></a>success</h2><p><img data-sizes="auto" data-src="https://gitee.com/tothemoon_2020/picgo/raw/master/image-20201013213251591.png" alt="image-20201013213251591" class="lazyload"></p>

  </article>

  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/ctf/">ctf</a>
    
    
</div>

  <div class="nexmoe-post-footer">
    
      
  <div class="nexmoe-post-copyright">
    <strong>本文作者：</strong>tothemoon<br>
    <strong>本文链接：</strong><a href="http://tothemoon2019.github.io/2020/10/15/%E7%AC%AC%20%E5%9B%9B%20%E5%91%A8%20writeup[%20BJDCTF-2020-Web-Cookie%20is%20so%20subtle!(twig,ssti)%20Bugku%20%E8%B9%AD%E7%BD%91%E5%85%88%E8%A7%A3%E5%BC%80%E5%AF%86%E7%A0%81(hashcat)%20[%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E9%9D%92%E9%BE%99%E7%BB%84]AreUSerialz(%E5%BA%8F%E5%88%97%E5%8C%96,protected)]/" title="http:&#x2F;&#x2F;tothemoon2019.github.io&#x2F;2020&#x2F;10&#x2F;15&#x2F;%E7%AC%AC%20%E5%9B%9B%20%E5%91%A8%20writeup[%20BJDCTF-2020-Web-Cookie%20is%20so%20subtle!(twig,ssti)%20Bugku%20%E8%B9%AD%E7%BD%91%E5%85%88%E8%A7%A3%E5%BC%80%E5%AF%86%E7%A0%81(hashcat)%20[%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E9%9D%92%E9%BE%99%E7%BB%84]AreUSerialz(%E5%BA%8F%E5%88%97%E5%8C%96,protected)]&#x2F;" target="_blank" rel="noopener">http:&#x2F;&#x2F;tothemoon2019.github.io&#x2F;2020&#x2F;10&#x2F;15&#x2F;%E7%AC%AC%20%E5%9B%9B%20%E5%91%A8%20writeup[%20BJDCTF-2020-Web-Cookie%20is%20so%20subtle!(twig,ssti)%20Bugku%20%E8%B9%AD%E7%BD%91%E5%85%88%E8%A7%A3%E5%BC%80%E5%AF%86%E7%A0%81(hashcat)%20[%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E9%9D%92%E9%BE%99%E7%BB%84]AreUSerialz(%E5%BA%8F%E5%88%97%E5%8C%96,protected)]&#x2F;</a><br>
    
      <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
    
  </div>


    
    <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '80b2453b6d5f37ad6225',
        clientSecret: '43e99fa852795c9a7b3eb924b2558c64b84bbdeb',
        id: window.location.pathname,
        repo: 'nexmoe.github.io',
        owner: 'nexmoe',
        admin: 'nexmoe'
    })
    gitalk.render('gitalk')
</script>
</section>
  </div>
</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js,gh/nexmoe/nexmoe.github.io@latest/js/app.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!--<script src="/js/app.js?v=1602765863217"></script>-->


    <script src="https://cdn.jsdelivr.net/gh/xtaodada/xtaodada.github.io@0.0.2/copy.js"></script>



  





</body>

</html>
